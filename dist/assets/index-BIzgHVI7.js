(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const h of o.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();const a={WIDTH:640,HEIGHT:480,SCALE:1},l={BG:"#1a1a2e",PRIMARY:"#ff6b35",SECONDARY:"#00ff88",DARK:"#0f3460",ACCENT:"#ff6b6b",COIN:"#ffcc00"},u=["C","D","E","F","G","A","B"],b={C:"A",D:"S",E:"D",F:"F",G:"G",A:"H",B:"J"},D={WIDTH:Math.floor(a.WIDTH/u.length)-8,HEIGHT:40,PADDING:4},d={Y:a.HEIGHT-80,HEIGHT:48,TOLERANCE:30},x=[{speed:.8,spawnInterval:1600,name:"Débutant"},{speed:1,spawnInterval:1300,name:"Facile"},{speed:1.3,spawnInterval:1e3,name:"Moyen"},{speed:1.6,spawnInterval:800,name:"Difficile"},{speed:2,spawnInterval:600,name:"Expert"}],I={a:"C",s:"D",d:"E",f:"F",g:"G",h:"A",j:"B",q:"C",w:"D",e:"E",r:"F",t:"G",y:"A",u:"B"},H={C:261.63,D:293.66,E:329.63,F:349.23,G:392,A:440,B:493.88},w=["E","G","A","G","E","D","C","D","E","G","A","B","A","G","E","D","C","E","G","E","F","A","G","F","E","D","C","E","D","C","D","C"],q={CHANCE:.15},_={HIT:100,BONUS_HIT:300},g={INITIAL:5,MAX:5},G={SCORE_THRESHOLD:1500,DISPLAY_DURATION:1e3},r={MENU:"menu",PLAYING:"playing",PAUSED:"paused",GAME_OVER:"gameover"},R={ENABLED:!1,SUPABASE_URL:"",SUPABASE_KEY:"",TABLE_NAME:"piano_hero_scores"};function K(i,t){return t.indexOf(i)}function z(i,t,e,s){const n=i+t,o=e-s,h=e+s+t;return n>=o&&i<=h}class N{constructor(t,e=!1){this.type=t,this.lane=K(t,u),this.isBonus=e,this.bonusImageIndex=e?Math.floor(Math.random()*100):0,this.hit=!1,this.missed=!1,this.y=-40;const s=a.WIDTH/u.length;this.x=this.lane*s+D.PADDING,this.width=s-D.PADDING*2,this.height=D.HEIGHT,this.animationFrame=0,this.hitAnimationTimer=0}update(t,e){const s=e/16.67;return this.y+=t*s,this.isBonus&&!this.hit&&(this.animationFrame+=e*.01),this.hit&&(this.hitAnimationTimer+=e),this.y>a.HEIGHT?(this.hit||(this.missed=!0),!1):!0}canBeHit(){return this.hit||this.missed?!1:z(this.y,this.height,d.Y,d.TOLERANCE)}markAsHit(){this.hit=!0,this.hitAnimationTimer=0}isHitAnimationComplete(){return this.hit&&this.hitAnimationTimer>200}getRenderData(){let t=1;this.isBonus&&!this.hit&&(t=1+Math.sin(this.animationFrame)*.1);let e=1;return this.hit&&(e=Math.max(0,1-this.hitAnimationTimer/200)),{x:this.x,y:this.y,width:this.width*t,height:this.height*t,type:this.type,lane:this.lane,isBonus:this.isBonus,bonusImageIndex:this.bonusImageIndex,hit:this.hit,missed:this.missed,alpha:e,scale:t}}static createRandom(t=.15){const e=Math.floor(Math.random()*u.length),s=u[e],n=Math.random()<t;return new N(s,n)}}class k{constructor(){this.keysDown=new Set,this.onNotePress=null,this.onNoteRelease=null,this._handleKeyDown=this._handleKeyDown.bind(this),this._handleKeyUp=this._handleKeyUp.bind(this),this._handleTouchStart=this._handleTouchStart.bind(this),this._handleTouchEnd=this._handleTouchEnd.bind(this),this.initialized=!1}init(){this.initialized||(document.addEventListener("keydown",this._handleKeyDown),document.addEventListener("keyup",this._handleKeyUp),this.initialized=!0)}setupTouchInput(t){if(!t)return;t.querySelectorAll(".key").forEach(s=>{s.addEventListener("touchstart",this._handleTouchStart,{passive:!1}),s.addEventListener("touchend",this._handleTouchEnd,{passive:!1}),s.addEventListener("mousedown",this._handleTouchStart),s.addEventListener("mouseup",this._handleTouchEnd),s.addEventListener("mouseleave",this._handleTouchEnd)})}destroy(){document.removeEventListener("keydown",this._handleKeyDown),document.removeEventListener("keyup",this._handleKeyUp),this.initialized=!1}setOnNotePress(t){this.onNotePress=t}setOnNoteRelease(t){this.onNoteRelease=t}isNoteDown(t){return this.keysDown.has(t)}getActiveNotes(){return Array.from(this.keysDown)}_handleKeyDown(t){const e=t.key.toLowerCase(),s=I[e];s&&!this.keysDown.has(s)&&(this.keysDown.add(s),this.onNotePress&&this.onNotePress(s))}_handleKeyUp(t){const e=t.key.toLowerCase(),s=I[e];s&&this.keysDown.has(s)&&(this.keysDown.delete(s),this.onNoteRelease&&this.onNoteRelease(s))}_handleTouchStart(t){t.preventDefault();const e=t.currentTarget,s=e.dataset.note;s&&u.includes(s)&&!this.keysDown.has(s)&&(this.keysDown.add(s),e.classList.add("active"),this.onNotePress&&this.onNotePress(s))}_handleTouchEnd(t){t.preventDefault();const e=t.currentTarget,s=e.dataset.note;s&&this.keysDown.has(s)&&(this.keysDown.delete(s),e.classList.remove("active"),this.onNoteRelease&&this.onNoteRelease(s))}static keyToNote(t){return I[t.toLowerCase()]||null}static getNoteKeys(t){return Object.entries(I).filter(([e,s])=>s===t).map(([e,s])=>e.toUpperCase())}}class X{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.setupCanvas(),this.laneWidth=a.WIDTH/u.length,this.fontLoaded=!1,this.bonusImages=[],this.bonusImagesLoaded=0,this.loadBonusImages()}loadBonusImages(){["bonus_piano.png","src/entities/bonus_pic/extracted_face_1.png","src/entities/bonus_pic/extracted_face_2.png","src/entities/bonus_pic/extracted_face_k1.png","src/entities/bonus_pic/extracted_face_k2.png","src/entities/bonus_pic/extracted_face_k3.png"].forEach((e,s)=>{const n=new Image;n.src=e,n.onload=()=>{this.bonusImagesLoaded++},n.onerror=()=>{},this.bonusImages.push(n)})}getRandomBonusImage(){const t=this.bonusImages.filter(e=>e.complete&&e.naturalWidth>0);return t.length===0?null:t[Math.floor(Math.random()*t.length)]}setupCanvas(){this.canvas.width=a.WIDTH,this.canvas.height=a.HEIGHT,this.canvas.style.width=`${a.WIDTH*a.SCALE}px`,this.canvas.style.height=`${a.HEIGHT*a.SCALE}px`,this.ctx.imageSmoothingEnabled=!1,this.canvas.style.imageRendering="pixelated",this.canvas.style.imageRendering="crisp-edges"}clear(){this.ctx.fillStyle=l.BG,this.ctx.fillRect(0,0,a.WIDTH,a.HEIGHT)}drawLanes(){this.ctx.strokeStyle=l.DARK,this.ctx.lineWidth=2;for(let t=1;t<u.length;t++){const e=Math.floor(t*this.laneWidth);this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,a.HEIGHT),this.ctx.stroke()}}drawHitZone(){this.ctx.fillStyle=l.SECONDARY,this.ctx.globalAlpha=.3,this.ctx.fillRect(0,d.Y,a.WIDTH,d.HEIGHT),this.ctx.globalAlpha=1,this.ctx.strokeStyle=l.PRIMARY,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(0,d.Y),this.ctx.lineTo(a.WIDTH,d.Y),this.ctx.stroke(),this.ctx.fillStyle=l.PRIMARY,this.ctx.font='16px "Press Start 2P", monospace',this.ctx.textAlign="center";for(let t=0;t<u.length;t++){const e=t*this.laneWidth+this.laneWidth/2,s=k.getNoteKeys(u[t]);this.ctx.fillText(s[0],e,d.Y+d.HEIGHT-8)}}drawNote(t){const{x:e,y:s,width:n,height:o,type:h,lane:c,isBonus:f,bonusImageIndex:m,hit:y,alpha:Y,scale:P}=t;this.ctx.globalAlpha=Y;const A=e+n/2/P,v=s+o/2/P,T=A-n/2,S=v-o/2;if(f){const L=this.bonusImages.filter(p=>p.complete&&p.naturalWidth>0),M=L.length>0?L[m%L.length]:null;if(M&&!y){const p=n+16,V=Math.floor(A-p/2),F=Math.floor(v-p/2);this.ctx.drawImage(M,V,F,p,p)}else this.ctx.fillStyle=y?l.SECONDARY:l.COIN,this.ctx.fillRect(Math.floor(T),Math.floor(S),Math.floor(n),Math.floor(o)),this.ctx.strokeStyle=l.DARK,this.ctx.lineWidth=2,this.ctx.strokeRect(Math.floor(T),Math.floor(S),Math.floor(n),Math.floor(o))}else this.ctx.fillStyle=y?l.DARK:l.PRIMARY,this.ctx.fillRect(Math.floor(T),Math.floor(S),Math.floor(n),Math.floor(o)),this.ctx.strokeStyle=l.DARK,this.ctx.lineWidth=2,this.ctx.strokeRect(Math.floor(T),Math.floor(S),Math.floor(n),Math.floor(o)),y||(this.ctx.fillStyle=l.BG,this.ctx.font='12px "Press Start 2P", monospace',this.ctx.textAlign="center",this.ctx.fillText(b[h],Math.floor(A),Math.floor(v+4)));this.ctx.globalAlpha=1}drawPiano(t=[]){const e=a.HEIGHT-48,s=40;for(let n=0;n<u.length;n++){const o=n*this.laneWidth,h=u[n],c=t.includes(h);this.ctx.fillStyle=c?l.PRIMARY:l.SECONDARY,this.ctx.fillRect(Math.floor(o+4),e,Math.floor(this.laneWidth-8),s),this.ctx.strokeStyle=l.DARK,this.ctx.lineWidth=2,this.ctx.strokeRect(Math.floor(o+4),e,Math.floor(this.laneWidth-8),s),this.ctx.fillStyle=c?l.BG:l.DARK,this.ctx.font='12px "Press Start 2P", monospace',this.ctx.textAlign="center",this.ctx.fillText(b[h],Math.floor(o+this.laneWidth/2),e+26)}}drawUI(t){const{score:e,highScore:s,level:n,levelName:o,lives:h,maxLives:c}=t;if(this.ctx.fillStyle=l.PRIMARY,this.ctx.font='16px "Press Start 2P", monospace',this.ctx.textAlign="left",this.ctx.fillText(`SCORE: ${e}`,8,24),this.ctx.textAlign="right",this.ctx.fillText(`MAX: ${s}`,a.WIDTH-8,24),o&&(this.ctx.textAlign="center",this.ctx.fillText(o.toUpperCase(),a.WIDTH/2,24)),h!==void 0){this.ctx.textAlign="left",this.ctx.font='12px "Press Start 2P", monospace';let f="";for(let m=0;m<c;m++)f+=m<h?"♥":"♡";this.ctx.fillStyle=(h>1,l.ACCENT),this.ctx.fillText(f,8,44)}}drawGameOverText(){this.ctx.fillStyle=l.BG,this.ctx.globalAlpha=.7,this.ctx.fillRect(a.WIDTH/2-140,a.HEIGHT/2-40,280,80),this.ctx.globalAlpha=1,this.ctx.strokeStyle=l.ACCENT,this.ctx.lineWidth=3,this.ctx.strokeRect(a.WIDTH/2-140,a.HEIGHT/2-40,280,80),this.ctx.fillStyle=l.ACCENT,this.ctx.font='20px "Press Start 2P", monospace',this.ctx.textAlign="center",this.ctx.fillText("GAME OVER",a.WIDTH/2,a.HEIGHT/2+8)}drawLevelUp(){this.ctx.fillStyle=l.BG,this.ctx.globalAlpha=.6,this.ctx.fillRect(a.WIDTH/2-120,a.HEIGHT/2-40,240,80),this.ctx.globalAlpha=1,this.ctx.strokeStyle=l.SECONDARY,this.ctx.lineWidth=3,this.ctx.strokeRect(a.WIDTH/2-120,a.HEIGHT/2-40,240,80),this.ctx.fillStyle=l.SECONDARY,this.ctx.font='20px "Press Start 2P", monospace',this.ctx.textAlign="center",this.ctx.fillText("LEVEL UP!",a.WIDTH/2,a.HEIGHT/2+8)}drawMenu(t){console.log("[Renderer] Dessin du menu"),this.clear(),this.ctx.fillStyle=l.PRIMARY,this.ctx.font='24px "Press Start 2P", monospace',this.ctx.textAlign="center",this.ctx.fillText("HERO DU",a.WIDTH/2,120),this.ctx.fillText("PIANO",a.WIDTH/2,160),this.ctx.font='12px "Press Start 2P", monospace',this.ctx.fillStyle=l.SECONDARY,this.ctx.fillText("APPUIE SUR LES TOUCHES",a.WIDTH/2,240),this.ctx.fillText("A S D F G H J",a.WIDTH/2,270),t>0&&(this.ctx.fillStyle=l.COIN,this.ctx.fillText(`RECORD: ${t}`,a.WIDTH/2,320)),this.ctx.fillStyle=l.PRIMARY,this.ctx.font='16px "Press Start 2P", monospace',this.ctx.fillText("CLIQUER POUR",a.WIDTH/2,400),this.ctx.fillText("COMMENCER",a.WIDTH/2,430)}drawPauseOverlay(){this.ctx.fillStyle=l.BG,this.ctx.globalAlpha=.8,this.ctx.fillRect(0,0,a.WIDTH,a.HEIGHT),this.ctx.globalAlpha=1,this.ctx.fillStyle=l.PRIMARY,this.ctx.font='24px "Press Start 2P", monospace',this.ctx.textAlign="center",this.ctx.fillText("PAUSE",a.WIDTH/2,a.HEIGHT/2),this.ctx.font='12px "Press Start 2P", monospace',this.ctx.fillText("ESPACE POUR REPRENDRE",a.WIDTH/2,a.HEIGHT/2+40)}drawGameOver(t,e,s){this.ctx.fillStyle=l.BG,this.ctx.globalAlpha=.9,this.ctx.fillRect(0,0,a.WIDTH,a.HEIGHT),this.ctx.globalAlpha=1,this.ctx.fillStyle=l.ACCENT,this.ctx.font='20px "Press Start 2P", monospace',this.ctx.textAlign="center",this.ctx.fillText("FIN DE PARTIE",a.WIDTH/2,160),this.ctx.fillStyle=l.PRIMARY,this.ctx.font='16px "Press Start 2P", monospace',this.ctx.fillText(`SCORE: ${t}`,a.WIDTH/2,240),s&&(this.ctx.fillStyle=l.COIN,this.ctx.fillText("NOUVEAU RECORD!",a.WIDTH/2,290)),this.ctx.fillStyle=l.SECONDARY,this.ctx.fillText(`RECORD: ${e}`,a.WIDTH/2,340),this.ctx.fillStyle=l.PRIMARY,this.ctx.font='12px "Press Start 2P", monospace',this.ctx.fillText("CLIQUER POUR REJOUER",a.WIDTH/2,420)}drawHitEffect(t){const e=t*this.laneWidth;this.ctx.fillStyle=l.PRIMARY,this.ctx.globalAlpha=.5,this.ctx.fillRect(e,d.Y-20,this.laneWidth,d.HEIGHT+40),this.ctx.globalAlpha=1}drawMissEffect(t){const e=t*this.laneWidth;this.ctx.fillStyle=l.ACCENT,this.ctx.globalAlpha=.5,this.ctx.fillRect(e,d.Y-20,this.laneWidth,d.HEIGHT+40),this.ctx.globalAlpha=1}}class ${constructor(){this.context=null,this.masterGain=null,this.melodyInterval=null,this.melodyIndex=0,this.volume=.3,this.muted=!1}init(){if(this.context)return!0;try{return this.context=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.context.createGain(),this.masterGain.connect(this.context.destination),this.masterGain.gain.value=this.volume,!0}catch(t){return console.warn("Impossible d'initialiser l'audio:",t),!1}}playTone(t,e=.15,s=.2){if(!this.context||this.muted)return;const n=this.context.createOscillator(),o=this.context.createGain();n.connect(o),o.connect(this.masterGain),n.type="square",n.frequency.setValueAtTime(t,this.context.currentTime),o.gain.setValueAtTime(0,this.context.currentTime),o.gain.linearRampToValueAtTime(s,this.context.currentTime+.01),o.gain.exponentialRampToValueAtTime(.01,this.context.currentTime+e),n.start(this.context.currentTime),n.stop(this.context.currentTime+e)}playNote(t){const e=H[t];e&&this.playTone(e,.15,.25)}playHitSound(t){const e=H[t];e&&this.playTone(e,.1,.3)}playBonusSound(){!this.context||this.muted||(this.playTone(523.25,.08,.2),setTimeout(()=>this.playTone(659.25,.08,.2),40),setTimeout(()=>this.playTone(783.99,.12,.25),80))}playMissSound(){if(!this.context||this.muted)return;const t=this.context.createOscillator(),e=this.context.createOscillator(),s=this.context.createGain();t.connect(s),e.connect(s),s.connect(this.masterGain),t.type="sawtooth",e.type="sawtooth",t.frequency.setValueAtTime(110,this.context.currentTime),e.frequency.setValueAtTime(117,this.context.currentTime),s.gain.setValueAtTime(.15,this.context.currentTime),s.gain.exponentialRampToValueAtTime(.01,this.context.currentTime+.2),t.start(this.context.currentTime),e.start(this.context.currentTime),t.stop(this.context.currentTime+.2),e.stop(this.context.currentTime+.2)}playMelodyTone(t,e=.5,s=.1){if(!this.context||this.muted)return;const n=this.context.createOscillator(),o=this.context.createGain();n.connect(o),o.connect(this.masterGain),n.type="triangle",n.frequency.setValueAtTime(t,this.context.currentTime),o.gain.setValueAtTime(0,this.context.currentTime),o.gain.linearRampToValueAtTime(s,this.context.currentTime+.05),o.gain.setValueAtTime(s,this.context.currentTime+e*.6),o.gain.exponentialRampToValueAtTime(.01,this.context.currentTime+e),n.start(this.context.currentTime),n.stop(this.context.currentTime+e)}startMelody(t=500){this.stopMelody(),this.melodyIndex=0,this.melodyInterval=setInterval(()=>{if(this.muted)return;const e=w[this.melodyIndex],s=H[e];s&&this.playMelodyTone(s,.45,.12),this.melodyIndex=(this.melodyIndex+1)%w.length},t)}stopMelody(){this.melodyInterval&&(clearInterval(this.melodyInterval),this.melodyInterval=null)}setMuted(t){this.muted=t,this.masterGain&&(this.masterGain.gain.value=t?0:this.volume)}toggleMute(){return this.setMuted(!this.muted),this.muted}setVolume(t){this.volume=Math.max(0,Math.min(1,t)),this.masterGain&&!this.muted&&(this.masterGain.gain.value=this.volume)}destroy(){this.stopMelody(),this.context&&(this.context.close(),this.context=null)}}class J{constructor(t){this.renderer=new X(t),this.input=new k,this.audio=new $,this.state=r.MENU,this.currentLevel=0,this.notes=[],this.score=0,this.highScore=this._loadHighScore(),this.lastScore=0,this.lives=g.INITIAL,this.startingLevel=0,this.lastLevelUpScore=0,this.levelUpDisplay=null,this.gameOverDisplay=null,this.lastTime=0,this.lastNoteSpawn=0,this.deltaTime=0,this.hitEffects=[],this.missEffects=[],this.onScoreChange=null,this.onStateChange=null,this.onLivesChange=null,this.onLevelChange=null,this._gameLoop=this._gameLoop.bind(this)}init(){this.input.init(),this.input.setOnNotePress(t=>this._handleNotePress(t)),this.renderer.drawMenu(this.highScore)}start(){console.log("[Game] Démarrage..."),this.audio.init(),this.notes=[],this.score=0,this.lastNoteSpawn=0,this.hitEffects=[],this.missEffects=[],this.lives=g.INITIAL,this.startingLevel=this.currentLevel,this.lastLevelUpScore=0,this.levelUpDisplay=null,this.gameOverDisplay=null,this.state=r.PLAYING,console.log("[Game] État changé à PLAYING"),this.onStateChange&&this.onStateChange(this.state),this.audio.startMelody(),this.lastTime=performance.now(),console.log("[Game] Lancement de la boucle de jeu"),requestAnimationFrame(this._gameLoop)}pause(){this.state===r.PLAYING&&(this.state=r.PAUSED,this.audio.stopMelody(),this.onStateChange&&this.onStateChange(this.state))}resume(){this.state===r.PAUSED&&(this.state=r.PLAYING,this.audio.startMelody(),this.lastTime=performance.now(),this.onStateChange&&this.onStateChange(this.state),requestAnimationFrame(this._gameLoop))}togglePause(){this.state===r.PLAYING?this.pause():this.state===r.PAUSED&&this.resume()}stop(){this.audio.stopMelody(),this.lastScore=this.score,this.score>this.highScore&&(this.highScore=this.score,this._saveHighScore()),this.state=r.GAME_OVER,this.onStateChange&&this.onStateChange(this.state)}goToMenu(){this.state=r.MENU,this.renderer.drawMenu(this.highScore),this.onStateChange&&this.onStateChange(this.state)}setLevel(t){this.state!==r.PLAYING&&(this.currentLevel=Math.max(0,Math.min(t,x.length-1)))}getCurrentLevel(){return x[this.currentLevel]}_gameLoop(t){if(this.deltaTime=t-this.lastTime,this.lastTime=t,this.deltaTime>100&&(this.deltaTime=16.67),this._update(),this._render(),this.gameOverDisplay){this.renderer.drawGameOverText(),this.gameOverDisplay.timer-=this.deltaTime,this.gameOverDisplay.timer<=0&&(this.gameOverDisplay=null,this.stop()),requestAnimationFrame(this._gameLoop);return}if(this.state===r.PLAYING)requestAnimationFrame(this._gameLoop);else if(this.state===r.PAUSED)this.renderer.drawPauseOverlay();else if(this.state===r.GAME_OVER){const e=this.lastScore===this.highScore&&this.lastScore>0;this.renderer.drawGameOver(this.lastScore,this.highScore,e)}}_update(){const t=this.getCurrentLevel();this.lastNoteSpawn+=this.deltaTime,this.lastNoteSpawn>=t.spawnInterval&&(this._spawnNote(),this.lastNoteSpawn=0);for(let e=this.notes.length-1;e>=0;e--){const s=this.notes[e];s.update(t.speed,this.deltaTime)||(s.missed&&(this.audio.playMissSound(),this._loseLife(s.lane)),this.notes.splice(e,1))}this._updateEffects()}_render(){this.renderer.clear(),this.renderer.drawLanes();for(const t of this.hitEffects)this.renderer.drawHitEffect(t.lane);for(const t of this.missEffects)this.renderer.drawMissEffect(t.lane);this.renderer.drawHitZone();for(const t of this.notes)this.renderer.drawNote(t.getRenderData());this.renderer.drawPiano(this.input.getActiveNotes()),this.renderer.drawUI({score:this.score,highScore:this.highScore,level:this.currentLevel,levelName:this.getCurrentLevel().name,lives:this.lives,maxLives:g.MAX}),this.levelUpDisplay&&this.renderer.drawLevelUp()}_spawnNote(){const t=N.createRandom(q.CHANCE);this.notes.push(t)}_handleNotePress(t){if(this.state===r.PLAYING){for(const e of this.notes)if(e.type===t&&e.canBeHit()){e.markAsHit();const s=e.isBonus?_.BONUS_HIT:_.HIT;this.score+=s,e.isBonus?this.audio.playBonusSound():this.audio.playHitSound(t),this._addHitEffect(e.lane),this._checkLevelUp(),this.onScoreChange&&this.onScoreChange(this.score);return}}}_loseLife(t){this.lives--,this.audio.playMissSound(),this._addMissEffect(t),this.onLivesChange&&this.onLivesChange(this.lives),this.lives<=0&&this._triggerGameOver()}_triggerGameOver(){this.audio.stopMelody(),this.gameOverDisplay={timer:1e3}}_checkLevelUp(){const t=G.SCORE_THRESHOLD,e=Math.floor(this.score/t),s=Math.floor(this.lastLevelUpScore/t);e>s&&(this.lastLevelUpScore=this.score,this.currentLevel<x.length-1&&(this.currentLevel++,this.levelUpDisplay={timer:G.DISPLAY_DURATION},this.onLevelChange&&this.onLevelChange(this.currentLevel)))}_addHitEffect(t){this.hitEffects.push({lane:t,timer:100})}_addMissEffect(t){this.missEffects.push({lane:t,timer:150})}_updateEffects(){for(let t=this.hitEffects.length-1;t>=0;t--)this.hitEffects[t].timer-=this.deltaTime,this.hitEffects[t].timer<=0&&this.hitEffects.splice(t,1);for(let t=this.missEffects.length-1;t>=0;t--)this.missEffects[t].timer-=this.deltaTime,this.missEffects[t].timer<=0&&this.missEffects.splice(t,1);this.levelUpDisplay&&(this.levelUpDisplay.timer-=this.deltaTime,this.levelUpDisplay.timer<=0&&(this.levelUpDisplay=null))}_loadHighScore(){try{const t=localStorage.getItem("herodupianoHighScore");return t?parseInt(t,10):0}catch{return 0}}_saveHighScore(){try{localStorage.setItem("herodupianoHighScore",this.highScore.toString())}catch{}}destroy(){this.input.destroy(),this.audio.destroy()}}class j{constructor(){this.enabled=R.ENABLED,this.client=null,this.scores=[],this.enabled&&this.initSupabase()}async initSupabase(){try{console.log("[Leaderboard] Supabase non configuré - mode placeholder")}catch(t){console.error("[Leaderboard] Erreur initialisation Supabase:",t),this.enabled=!1}}async getTopScores(t=10){if(!this.enabled||!this.client)return this.getPlaceholderScores(t);try{const{data:e,error:s}=await this.client.from(R.TABLE_NAME).select("*").order("score",{ascending:!1}).limit(t);if(s)throw s;return this.scores=e,e}catch(e){return console.error("[Leaderboard] Erreur récupération scores:",e),this.getPlaceholderScores(t)}}async submitScore(t,e,s=1){if(!this.enabled||!this.client)return console.log("[Leaderboard] Score non soumis (désactivé):",{playerName:t,score:e,level:s}),!1;try{const{error:n}=await this.client.from(R.TABLE_NAME).insert([{player_name:t,score:e,level:s,created_at:new Date().toISOString()}]);if(n)throw n;return console.log("[Leaderboard] Score soumis:",{playerName:t,score:e}),!0}catch(n){return console.error("[Leaderboard] Erreur soumission score:",n),!1}}async isHighScore(t){const e=await this.getTopScores(10);return e.length<10?!0:t>e[e.length-1].score}getPlaceholderScores(t=5){return[{rank:1,player_name:"---",score:0},{rank:2,player_name:"---",score:0},{rank:3,player_name:"---",score:0},{rank:4,player_name:"---",score:0},{rank:5,player_name:"---",score:0}].slice(0,t)}getStatus(){return this.enabled?this.client?"Connecté":"Connexion en cours...":"Leaderboard désactivé"}}const O=new j;document.addEventListener("DOMContentLoaded",()=>{console.log("[Piano Hero] Initialisation...");const i=document.getElementById("game-canvas");if(!i){console.error("Canvas non trouvé !");return}console.log("[Piano Hero] Canvas trouvé:",i);const t=new J(i);console.log("[Piano Hero] Instance créée, état:",t.state),t.init(),console.log("[Piano Hero] Jeu initialisé"),Q(t),Z(t),tt(),et(),window.game=t,console.log("[Piano Hero] Prêt ! Tapez game.start() dans la console pour tester.")});function Q(i){const t=document.getElementById("game-canvas"),e=document.getElementById("start-btn"),s=document.getElementById("mute-btn"),n=()=>{(i.state===r.MENU||i.state===r.GAME_OVER)&&(i.start(),E(i.state))};t.addEventListener("click",n),e&&e.addEventListener("click",()=>{console.log("[Piano Hero] Clic sur Start, état actuel:",i.state),i.state===r.PLAYING?i.stop():i.start(),console.log("[Piano Hero] Nouvel état:",i.state),E(i.state)}),s&&s.addEventListener("click",()=>{const o=i.audio.toggleMute();s.textContent=o?"SON: OFF":"SON: ON",s.classList.toggle("muted",o)}),document.addEventListener("keydown",o=>{o.code==="Space"&&(o.preventDefault(),i.state===r.PLAYING||i.state===r.PAUSED?i.togglePause():(i.state===r.MENU||i.state===r.GAME_OVER)&&i.start(),E(i.state)),o.code==="Escape"&&(i.state===r.PLAYING||i.state===r.PAUSED)&&(i.stop(),i.goToMenu(),E(i.state))}),i.onStateChange=o=>{E(o),o===r.PLAYING&&B(g.INITIAL)},i.onScoreChange=o=>{const h=document.querySelector("#score span");if(h&&(h.textContent=o),o>i.highScore){const c=document.querySelector("#high-score span");c&&(c.textContent=o)}},i.onLivesChange=o=>{B(o)},i.onLevelChange=o=>{const h=document.getElementById("level-selector");h&&h.querySelectorAll(".level-btn").forEach((f,m)=>{f.classList.toggle("active",m===o)});const c=document.getElementById("level-name");c&&(c.textContent=x[o].name)}}function B(i){const t=document.querySelector("#lives span");if(t){let e="";for(let s=0;s<g.MAX;s++)e+=s<i?"♥":"♡";t.textContent=e}}function E(i){const t=document.getElementById("start-btn");if(t)switch(i){case r.MENU:t.textContent="JOUER",t.disabled=!1;break;case r.PLAYING:t.textContent="STOP",t.disabled=!1;break;case r.PAUSED:t.textContent="REPRENDRE",t.disabled=!1;break;case r.GAME_OVER:t.textContent="REJOUER",t.disabled=!1;break}}function Z(i){const t=document.getElementById("level-selector");if(!t)return;t.innerHTML="",x.forEach((s,n)=>{const o=document.createElement("button");o.className="level-btn"+(n===0?" active":""),o.textContent=(n+1).toString(),o.title=s.name,o.addEventListener("click",()=>{if(i.state===r.PLAYING)return;i.setLevel(n),t.querySelectorAll(".level-btn").forEach((c,f)=>{c.classList.toggle("active",f===n)});const h=document.getElementById("level-name");h&&(h.textContent=s.name)}),t.appendChild(o)});const e=document.getElementById("level-name");e&&(e.textContent=x[0].name)}function tt(){document.getElementById("help-modal");const i=document.getElementById("help-ok-btn"),t=document.getElementById("help-btn"),e=document.getElementById("dont-show-again");i&&i.addEventListener("click",()=>{e&&e.checked&&localStorage.setItem("piano-hero-help-seen","true"),C()}),t&&t.addEventListener("click",()=>{W()}),document.addEventListener("keydown",o=>{o.code==="Escape"&&(C(),U())}),document.getElementById("leaderboard-modal");const s=document.getElementById("leaderboard-btn"),n=document.getElementById("leaderboard-close-btn");s&&s.addEventListener("click",()=>{st()}),n&&n.addEventListener("click",()=>{U()})}function et(){localStorage.getItem("piano-hero-help-seen")?C():W()}function W(){const i=document.getElementById("help-modal");i&&(i.style.display="flex",i.classList.remove("hidden"))}function C(){const i=document.getElementById("help-modal");i&&(i.style.display="none",i.classList.add("hidden"))}async function st(){const i=document.getElementById("leaderboard-modal"),t=document.querySelector(".leaderboard-status");if(i){i.style.display="flex",i.classList.remove("hidden"),t&&(t.textContent=O.getStatus());const e=await O.getTopScores(5);it(e)}}function U(){const i=document.getElementById("leaderboard-modal");i&&(i.style.display="none",i.classList.add("hidden"))}function it(i){const t=document.getElementById("leaderboard-list");if(!t)return;t.querySelectorAll(".leaderboard-entry").forEach((s,n)=>{const o=s.querySelector(".name"),h=s.querySelector(".lb-score");i[n]?(o.textContent=i[n].player_name||"---",h.textContent=i[n].score||0):(o.textContent="---",h.textContent="0")})}
